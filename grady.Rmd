---
title: "Stranded Turtles Hawaii Island"
author: Grady Weyenberg
output:
  html_document:
    df_print: paged
    code_folding: hide
    toc: yes
  pdf_document:
    toc: yes
  word_document:
    toc: yes
---

```{r setup, include=FALSE}
library(readxl)
library(tidyr)
library(dplyr)
library(magrittr)
library(ggplot2)
library(lubridate)
library(forcats)
library(nnet)
library(splines)
```

## Data wrangling

```{r}
turtles <- read_excel("Stranding Data Set.xlsx")
turtles_clean <- turtles %>% 
  mutate(date = parse_date_time(paste(Month, Year), "my"), 
         year = year(date),
         cause=fct_collapse(Cause, natural=c("Shark attack", "Misc.", "FP"), 
                            human=c("Human take", "Net", "Hook/line", "Boat impact"),
                            #FP="FP",
                            unknown=c("Unknown"))) %>%
  select(date, cause, everything(), -Year, -Month)
turtles_clean  
write.csv(turtles_clean, "turtles_clean.csv")
turtles_count <- turtles_clean %>% count(year, cause, name="strandings", .drop=FALSE)
turtles_count
turtles_count %>% group_by(cause) %>% filter(year >= 1985, year != 2011) %>% summarize(n = sum(strandings)) %>% mutate(p=n/sum(n))
```

## Exploration

```{r}
timecountplot <- ggplot(turtles_count) + 
  aes(year, strandings, color=cause, shape=year<2020) + 
  geom_point(position=position_dodge(width=1)) + 
  scale_shape_manual(values = c(1,16), guide="none") +
  scale_color_brewer(palette="Dark2")
timecountplot + geom_smooth(data= ~filter(.x, year<2020), 
                            formula = y~x,
                            method="loess", span=1)
```

```{r}
# turtles_count %>% filter(cause!="unknown") %>% group_by(year) %>% mutate(total=sum(strandings), prop=strandings/total)

(triclassplot <- ggplot( turtles_count %>% 
         filter() %>% 
         group_by(year) %>% 
         mutate(total=sum(strandings), 
                prop=strandings/total, 
                cause=fct_relevel(cause, "human", "unknown", "natural"))) + 
  aes(year, prop, color=cause) + geom_col(aes(fill=cause)) +
  geom_hline(yintercept=c(0.12, 1-0.30), lty=2, color="white") + 
  labs(title="Cause proportion over years")) + 
  scale_fill_brewer(type="qual", aesthetics = c("color", "fill"), palette = "Set2")
```

And with unknown cases removed.

```{r,  warning=FALSE}
(biclassplot <- ggplot( turtles_count %>% 
         filter(cause!="unknown") %>% 
         group_by(year) %>% 
         mutate(total=sum(strandings), prop=strandings/total)) + 
  aes(year, prop, color=cause) + geom_col(aes(fill=cause)) +
  geom_hline(yintercept=0.249, lty=2) +
  labs(title="Cause proportion over years")) + 
  scale_color_brewer(palette="Set2", aesthetics = c("color", "fill"))
```


## Modelling

Here I try out some generalized linear models. The general framework is that the response observations $Y$ are generated by some probability model, the parameter of which is controlled by some function of the predictor variables. 

The traditional linear regression model is that $Y \sim N(\mu, \sigma)$, where $\mu = a + b\cdot X$. 

Below I try out an assortment of models where the response $Y$ is either a Poisson count, a Bernoulli two-category distribution, and finally a Multinomial 3-category distribution.


### Identity link Poisson model

The count of strandings per year is Poisson, with mean determined by a linear function of year.

```{r, warning=FALSE}
countsmodel <- glm(strandings~year * cause, 
                   poisson(link = "identity"), 
                   turtles_count %>% filter(year < 2020), 
                   start = c(1,0,0,0,0,0))

#countsmodel <- glm(strandings~year + cause, quasipoisson(link = "log"), turtles_count %>% filter(year < 2020))

countsmodel

timecountplot + geom_line(aes(y=predict(countsmodel, newdata=turtles_count, type="response"), shape=NULL))
#ggplot(turtles_count %>% filter(year < 2020), aes(year, strandings, color=cause)) + 
#  geom_point() + geom_line(aes(y=predict(countsmodel, type="response")))
```

### Log link Poisson

Below is a more conventional Poisson regression model, where the Poisson mean parameter $\mu$ is controlled exponentially by the year as $\log \mu = a + b\times\text{year}$. The interaction is not significant, which implies that the ratios between the Poisson rates for the different causes are constant over time. This is our first formal evidence of what we observed in the proportion charts above. 

```{r}
countsmodel2 <- glm(strandings~year * cause, poisson(link = "log"), turtles_count %>% filter(year < 2020, year > 1984))

countsmodel2 %>% anova(test="LRT")

countsmodel3 <- update(countsmodel2, . ~ . - year:cause)

timecountplot + geom_line(aes(y=predict(countsmodel3, newdata = turtles_count, type="response"), shape=NULL))

#ggplot(turtles_count %>% filter(year < 2020), aes(year, strandings, color=cause)) + 
#  geom_point() + 
#  geom_line(aes(y=predict(update(countsmodel2, .~ . - year:cause), type="response"))) #+
  #geom_line(aes(y=predict(glm(strandings~year, poisson), type="response")), color=1)

```

### Identity link binomial

Now we'll try some logistic regression. Remove the unknown category. The model is that the proportion of natural strandings is a linear function of year. The year term is not significant using a likelihood ratio test. Two standard error confidence band for the predicted proportion is shown.

```{r binomident, class.source = 'fold-show'}
turtles_known <- turtles_clean %>% filter(cause!="unknown") #, year < 2020)
binommodel <- glm(cause ~ year, binomial(link="identity"), turtles_known, weights = (turtles_known$year>1984) + 0)

binommodel  %>% anova(test="LRT")
```

```{r, warning=FALSE}
#glm(cause ~ 1, binomial(link="identity"), turtles_known) 

turtles_known %>% count(cause) %>% mutate(proportions(n))

ggplot(cbind(turtles_known, predict(binommodel, type="response", se.fit=TRUE))) +
  geom_col(aes(year, prop, color=cause, fill=cause), inherit.aes = FALSE,
           turtles_count %>% filter(cause!="unknown") %>% 
             group_by(year) %>% 
             mutate(total=sum(strandings), prop=strandings/total) ) + 
  aes(year, fit, ymin=fit - 2*se.fit, ymax = fit + 2*se.fit) + 
  geom_line() + 
  geom_ribbon(alpha=0.2) + 
  geom_hline(yintercept=0.311, lty=3) + 
  labs(y="Proportion")
```

### Logit link binomial

A similar model, but with the more traditional "logit" link, where the linear function predicts the "log-odds" instead of the probability directly, producing the traditional sigmoid curve in probability-space. The results are qualitatively the same as with the "identity" link above, the proportion is not changing over time. 

This model produces nearly the exact same results as the "identity" link model above. The curvature of the sigmoid shape is barely detectable by the eye.

```{r binomlogit, class.source = 'fold-show'}
binommodel2 <- glm(cause ~ year, binomial(link="logit"), turtles_known)

binommodel2  %>% anova(test="LRT")
```

```{r, warning=FALSE}
#glm(cause ~ 1, binomial(link="logit"), turtles_known)
#1/(1+exp(--1.103))

ggplot(cbind(turtles_known, predict(binommodel2, newdata=turtles_known, type="response", se.fit=TRUE))) +
  geom_col(aes(year, prop, color=cause, fill=cause), inherit.aes = FALSE,
           turtles_count %>% filter(cause!="unknown") %>% 
             group_by(year) %>% 
             mutate(total=sum(strandings), prop=strandings/total) ) + 
  scale_color_brewer(palette="Set2", aesthetics = c("fill", "color")) + 
  aes(year, fit, ymin=fit - 2*se.fit, ymax = fit + 2*se.fit, ) + 
  geom_line() + 
  geom_ribbon(alpha=0.2) + 
  geom_hline(yintercept=0.249, lty=3) + 
  labs(y="Proportion")
  
```

### Multinomial regression

Generalize to include all three categories. Model selection by AIC again chooses a model where the class proportions are independent of the year. The three-color column graph at the beginning is the preferred model.

```{r multnom, class.source = 'fold-show'}
multinom(cause~year, turtles_clean, trace=FALSE) %>% step
```

### Multinomial regression with natural splines

Here's some spline fit multinomial models. The AIC selects 5 degrees of freedom as optimal. I'm suspicious of that, the AIC is only marginally improved for the 4 dof model over the null model.

```{r}
cubicmultnom <- multinom(cause~ns(year, df=5), turtles_clean, trace=FALSE)
cubicmultnom
triclassplot +
  scale_fill_brewer(type="qual", aesthetics = c("color", "fill"), palette = "Set2") + 
  geom_line(aes(y=1-human, color=NULL), cbind(turtles_clean, predict(cubicmultnom, type="probs"))) + 
  geom_line(aes(y=natural, color=NULL), cbind(turtles_clean, predict(cubicmultnom, type="probs")))

```

Here's a 4 deg of freedom fit with some bootstrapping to investigate the model variability. The bands seem to encompass the horizontal lines, except for maybe the very early years in the study. Seems like the early years are driving a lot of the preference for more complicated models.

```{r, message=FALSE, warning=FALSE}
cubicmultnom <- multinom(cause~ns(year, df=4), turtles_clean, trace=FALSE)
cubicmultnom
bootns <- purrr::rerun(100, multinom(cause~ns(year, df=4), turtles_clean %>% slice_sample(prop=1, replace=TRUE), trace=FALSE) %>% predict(newdata=turtles_clean, type="probs") %>% cbind(turtles_clean,.)) %>% bind_rows(.id="run")
#bootns

triclassplot + 
  geom_line(aes(y=1-human, group=run, color=NULL), bootns, color=1, alpha=0.15) + 
  geom_line(aes(y=natural, group=run, color=NULL), bootns, color=1, alpha=0.15) + 
  scale_fill_brewer(type="qual", aesthetics = c("color", "fill"), palette = "Set2") + 
  geom_line(aes(y=1-human, color=NULL), cbind(turtles_clean, predict(cubicmultnom, type="probs")), color=3, lwd=1, lty=2) + 
  geom_line(aes(y=natural, color=NULL), cbind(turtles_clean, predict(cubicmultnom, type="probs")), color=3, lwd=1, lty=2)


```

## Exclude first few years

Without the years before 1985 included in the data, there really does not appear to be a need for any dependence on year. The AIC changes by less than 1 going from a 1 df spline to 4.

```{r, message=FALSE, warning=FALSE}
cubicmultnom2 <- multinom(cause~ns(year, df=3), turtles_clean, year >= 1985 & year != 2011, trace=FALSE)
cubicmultnom2

bootns2 <- purrr::rerun(2000, 
                       multinom(cause~ns(year, df=3), 
                                turtles_clean %>% slice_sample(prop=1, replace=TRUE), 
                                year>=1985 & year != 2011,
                                trace=FALSE) %>% 
                         predict(newdata=turtles_clean, type="probs") %>% 
                         cbind(turtles_clean,.)) %>% 
  bind_rows(.id="run")

bootci <- bootns2 %>% 
  group_by(year) %>% 
  summarize(human_L=1-quantile(human, 0.025), 
            human_U=1-quantile(human,1-0.025),
            natural_L=quantile(natural,0.025),
            natural_U=quantile(natural,1-0.025)) %>%
  pivot_longer(-year, names_sep = "_", names_to = c("cause", "bound")) %>%
  pivot_wider(names_from = "bound", values_from = "value")
#bootci
save(bootci, cubicmultnom2, file="bootci.rda")

triclassplot +
  #geom_line(aes(y=1-human, group=run, color=NULL), bootns2, color=1, alpha=0.15) + 
  #geom_line(aes(y=natural, group=run, color=NULL), bootns2, color=1, alpha=0.15) + 
  scale_fill_brewer(type="qual", aesthetics = c("color", "fill"), palette = "Set2",
                    name="Cause", labels=c("Human", "Unknown", "Predation, disease\nand weather")) + 
  geom_ribbon(aes(year,ymin=L, ymax=U, group=cause), data=bootci, inherit.aes = FALSE,alpha=0.25) +
  geom_line(aes(y=1-human, color=NULL), cbind(turtles_clean, predict(cubicmultnom2, type="probs")), color=1, lty=1) + 
  geom_line(aes(y=natural, color=NULL), cbind(turtles_clean, predict(cubicmultnom2, type="probs")), color=1, lty=1) + 
  annotate("text", x=c(1983,1984,2011), y=0.01, label="*", size=4) + 
  labs(y="proportion") + 
  theme(legend.position=c(0.5,0.96), legend.direction = "horizontal", legend.justification = c(0.5,1), 
         legend.background = element_rect(fill=alpha("white", 0.55)) )
  #theme(legend.position="top", legend.direction = "horizontal")
  #guides(fill="none", color="none")
ggsave("splineplot.png", width=6, height=4)
```



```{r, message=FALSE, warning=FALSE}
quarticmultnom2 <- multinom(cause~ns(year, df=4), turtles_clean, year >= 1985 & year != 2011, trace=FALSE)
quarticmultnom2
bootns4 <- purrr::rerun(2000, 
                       multinom(cause~ns(year, df=4), 
                                turtles_clean %>% slice_sample(prop=1, replace=TRUE), 
                                year>=1985 & year != 2011,
                                trace=FALSE) %>% 
                         predict(newdata=turtles_clean, type="probs") %>% 
                         cbind(turtles_clean,.)) %>% 
  bind_rows(.id="run")

bootci4 <- bootns4 %>% 
  group_by(year) %>% 
  summarize(human_L=1-quantile(human, 0.025), 
            human_U=1-quantile(human,1-0.025),
            natural_L=quantile(natural,0.025),
            natural_U=quantile(natural,1-0.025)) %>%
  pivot_longer(-year, names_sep = "_", names_to = c("cause", "bound")) %>%
  pivot_wider(names_from = "bound", values_from = "value")
#bootci


triclassplot +
  #geom_line(aes(y=1-human, group=run, color=NULL), bootns2, color=1, alpha=0.15) + 
  #geom_line(aes(y=natural, group=run, color=NULL), bootns2, color=1, alpha=0.15) + 
  scale_fill_brewer(type="qual", aesthetics = c("color", "fill"), palette = "Set2",
                    name="Cause", labels=c("Human", "Unknown", "Predation, disease\n and weather")) + 
  geom_ribbon(aes(year,ymin=L, ymax=U, group=cause), data=bootci4, inherit.aes = FALSE,alpha=0.25) +
  geom_line(aes(y=1-human, color=NULL), cbind(turtles_clean, predict(quarticmultnom2, type="probs")), color=1, lty=1) + 
  geom_line(aes(y=natural, color=NULL), cbind(turtles_clean, predict(quarticmultnom2, type="probs")), color=1, lty=1) + 
   theme(legend.position=c(0.5,0.96), legend.direction = "horizontal", legend.justification = c(0.5,1), 
         legend.background = element_rect(fill=alpha("white", 0.65)) )
  #theme(legend.position="top", legend.direction = "horizontal")
  #guides(fill="none", color="none")
```


## Request: Don't Lump FP with natural

```{r}
turtles_clean <- turtles_clean %>% mutate(cause4=fct_collapse(Cause,
                                             human = c( "Human take", "Net", "Hook/line", "Boat impact"),
                                             unknown = c("Unknown"),
                                             #fp = "FP",
                                             natural=c("Misc.", "Shark attack", "FP")
                                             ))
turtles_count4 <- turtles_clean %>% count(year, cause4, name="strandings", .drop=FALSE)
#turtles_count4
turtles_count4 %>% group_by(cause4) %>% summarize(n = sum(strandings)) %>% mutate(p=proportions(n))


quadclassplot <- ggplot( turtles_count4 %>% 
         filter() %>% 
         group_by(year) %>% 
         mutate(total=sum(strandings), prop=strandings/total,
                cause4=fct_relevel(cause4, "human", "unknown", "natural"))) + 
  aes(year, prop, color=cause4) + geom_col(aes(fill=cause4)) +
  #geom_hline(yintercept=c(0.312, 1-0.103), lty=2, color="white") + 
  labs(title="Cause proportion over years")
quadclassplot  
multnom4 <- multinom(cause4~ns(year, df=4), turtles_clean, year>=1985 & year !=2011, trace=TRUE)
multnom4 %>% summary

quadclassplot +
  geom_line(aes(y=1-human, color=NULL), cbind(turtles_clean, predict(multnom4, type="probs"))) + 
  #geom_line(aes(y=fp, color=NULL), cbind(turtles_clean, predict(multnom4, type="probs"))) +
  geom_line(aes(y=natural, color=NULL), cbind(turtles_clean, predict(multnom4, type="probs")))

```

Predation + Disease + Natural Disaster

Exclude 2011 due to Tohoku quake causing non-predictive spike in natural distaster (misc.) category.s

## Discussion

The different approaches mostly seem to agree on the same qualitative conclusion: While the number of strandings is going up over time, we don't see convincing evidence that the proportions between human/natural causes are changing over time. (The same holds when we include a third "unknown" cause category.)


```{r}
anova(
  multinom(cause~ns(year, df=4), turtles_clean, year >= 1980 & year != 2011, trace=FALSE),
  multinom(cause~ns(year, df=3), turtles_clean, year >= 1980 & year != 2011, trace=FALSE),
  multinom(cause~ns(year, df=2), turtles_clean, year >= 1980 & year != 2011, trace=FALSE),
  multinom(cause~year, turtles_clean, year >= 1980 & year != 2011, trace=FALSE),
  multinom(cause~1, turtles_clean, year >= 1980 & year != 2011, trace=FALSE)
  )

multinom(cause~ns(year, df=4), turtles_clean, year >= 1985 & year != 2011, trace=FALSE) %>% AIC
multinom(cause~ns(year, df=3), turtles_clean, year >= 1985 & year != 2011, trace=FALSE) %>% AIC
multinom(cause~ns(year, df=2), turtles_clean, year >= 1985 & year != 2011, trace=FALSE) %>% AIC
multinom(cause~year, turtles_clean, year >= 1985 & year != 2011, trace=FALSE) %>% AIC
multinom(cause~1, turtles_clean, year >= 1985 & year != 2011, trace=FALSE) %>% AIC
```


## Pie chart


```{r}
turtles_clean %>% count(Cause, Side) %>% 
  pivot_wider(names_from = Side, values_from=n) %>% 
  mutate(Total=E+W, across(-Cause, ~paste0(.x, " (", round(.x/sum(.x)*100, 1), "\\%)"))) %>%
  knitr::kable("latex")
  
```


```{r}
turtles_clean %>% count(Cause, Status, .drop = FALSE) %>% 
  pivot_wider(names_from = Status, values_from = n) %>% 
  replace_na(replace=list(U=0)) %>% 
  rename(Alive=A, Dean=D, Unknown=U) %>%
  knitr::kable("latex")

```



## Bar graphs

```{r}
ggplot(turtles_clean) + aes(x=Cause, y=SCL) + geom_boxplot() + 
  labs(y="Carapace length (cm) ")
```

## Skylar's big excel file

```{r}
BigIslandStrandings1 <- read_xlsx("BigIslandStrandings.xlsx", sheet=1)
BigIslandStrandings2 <- read_xlsx("BigIslandStrandings.xlsx", sheet=2)

library(stringr)

fix_coords <- function(x, sign=1){
  if(isTRUE(str_detect(x,"[°']"))){
    str_replace_all(x,"[°']", " ") %>% measurements::conv_unit("deg_min_sec", "dec_deg") %>% as.numeric %>% print %>% abs %>% multiply_by(sign)
  } else {
      as.numeric(x) %>% abs %>% multiply_by(sign)}
  }

BigIslandStrandings$`Lat DD...23` %>% purrr::map_vec(fix_coords)
BigIslandStrandings$`Long DD...24` %>% purrr::map_vec(fix_coords, sign=-1)

BigIslandStrandings1 <- BigIslandStrandings1 %>% mutate(across(starts_with("Lat DD"), fix_coords), across(starts_with("Long DD"), ~fix_coords(.x, -1)))
BigIslandStrandings2 <- BigIslandStrandings2 %>% mutate(across(starts_with("Lat DD"), fix_coords), across(starts_with("Long DD"), ~fix_coords(.x, -1)))

lat_long <- bind_rows(
  BigIslandStrandings1 %>% select(starts_with(c("Lat", "Long")), Site) %>% rename("Lat"=1, "Long"=3) %>% select(1,3, Site) %>% mutate(Side="East"),
  BigIslandStrandings2 %>% select(starts_with(c("Lat", "Long")), Site) %>% rename("Lat"=1, "Long"=3) %>% select(1,3, Site) %>% mutate(Side="West")
)


BigIslandStrandings <- rbind(
  BigIslandStrandings1 %>% relocate(Date, Year, Month, Side, Site, Cause, 
                                  InitialStatus="Init Status", 
                                  FinalStatus="Survival Status", Sex, SCL:Plastron, Tumor="Tumor Present?",
                                  Lat="Lat DD...23", Long="Long DD...24", Mass="WEIGHT_LB") %>% select(1:Mass),
  BigIslandStrandings2 %>% relocate(Date, Year, Month, Side, Site, Cause,
                                  InitialStatus="Init Status...31",
                                  FinalStatus="Survival Status...32",
                                  Sex, SCL:Plastron, Tumor="Tumor Present?", 
                                  Lat="Lat DD...29", Long="Long DD...30", Mass="WEIGHT_LB") %>% select(1:Mass)
) %>% mutate(Lat = ifelse(Lat>90, NA, Lat), 
             Long=ifelse(Long>-150, NA, Long), ## some 99.9999 values
             Mass = Mass %>% ifelse(. > 777, NA, .) %>% #na_if(0) %>% na_if(777.7) %>% na_if(888.8) %>% na_if(999.9) %>% 
               units::set_units(lb) %>% units::set_units(kg),
             across(SCL:Plastron, ~units::set_units(na_if(.x, 0), cm))
             )
BigIslandStrandings %>% reframe(across(Site, unique)) %>% arrange(Site)
BigIslandStrandings %>% readr::write_csv("BigIslandStrandings.csv")
```

```{r}
library(tmap)
library(sf)
hawaii.sf <- read_sf("Coastline/Coastline.shp") 
#hawaii.sf <- read_sf("coast_n83.shp")
#st_bbox(hawaii.sf %>% filter(isle=="Hawaii"))

turtlepoints <- data.frame(lat=c(19.75, 19.3), 
                           long=c(-155.0, -155.85), 
                           Side=c("East","West")) %>% st_as_sf(coords=c("long", "lat"), crs=4326)

turtlepoints <- hawaii.sf %>% filter(isle=="Hawaii") %>% 
  rmapshaper::ms_simplify(0.001) %>% st_segmentize(1000) %>% 
  st_coordinates() %>% as.data.frame() %>% slice_sample(n=100) %>% 
  cbind(., Side=ifelse(.$X< -155.8, "West", "East")) %>% st_as_sf(coords=c("X", "Y"), crs=4326)

turtlepoints <- lat_long %>% na.omit %>% st_as_sf(coords=c("Long", "Lat"), crs=4326)
turtlepoints <- BigIslandStrandings %>% st_as_sf(coords=c("Long", "Lat"), crs=4326, na.fail=FALSE)

turtlepoints <- BigIslandStrandings %>% mutate(Dist= hawaii.sf[13,] %>% 
                          st_cast("LINESTRING", warn=FALSE) %>% 
                          st_distance(turtlepoints, .) %>% drop)

BigIslandStrandings %>% mutate(Dist = turtlepoints$Dist) %>% readr::write_csv("BigIslandStrandings.csv", na="")                        
#readr::write_csv(turtlepoints, "turtlepoints.csv")

turtlepoints %>% filter(Dist > units::set_units(5000, m)) %>% print(n=50)
turtlepoints %>% arrange(desc(Dist)) %>% print(n=50)

tm_shape(hawaii.sf, simplify=0.0125, bbox=c(-156.15, 18.91, -154.8, 20.27)) + 
  tm_graticules(alpha=0.4, n.x=4, n.y=4) + 
  tm_borders() + tm_compass() + tm_scale_bar() + 
  tm_fill(alpha=0.3) + 
  #tm_credits("PLACEHOLDER", position=c("center", "center"), size=1.5) + 
  tm_shape(turtlepoints %>% filter(Dist > units::set_units(3000, m))) + 
  tm_symbols(shape="Side", alpha=0.2, size=0.3, col="black", border.alpha=1, border.lwd =  1) + 
  #tm_text(text="Site", size=0.6) + 
  tm_legend(position=c(0.95,0.95), just=c(1,1), frame=TRUE) 
```

